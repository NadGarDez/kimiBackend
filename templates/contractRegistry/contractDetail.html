{% extends 'base.html' %}
{% load static %}

{% block title %}
  Registry - Detalle del Contrato: {{ contract.instance.name }}
{% endblock %}

{% block content %}
  <div class="centered-container mx-auto dashboard-content">
    
    <div class="d-flex justify-content-between align-items-center mb-4 border-0">
      <h2 class="h3 text-accent mb-0" style="border-bottom: none !important;">Detalle del Contrato: <span class="fw-bold text-light">{{ contract.instance.name }}</span></h2>

      <a href="{% url 'contractRegistry:contract_list' %}" class="btn btn-outline-info fw-bold text-uppercase"><i class="bi bi-arrow-left-circle me-2"></i> Volver a la Lista</a>
    </div>

    <hr class="text-accent mt-0 mb-4" />

    <div class="mb-4 welcome-card p-3 d-flex justify-content-between align-items-start">
      <div style="text-align: justify;" class="me-5">
        <p class="mb-1 text-text-dim">
          <strong>Descripción:</strong> {{ contract.instance.descripcion|default:"No hay descripción disponible." }}
        </p>
        <p class="mb-0 text-text-dim">
          <strong>Contrato ID Interno (PK):</strong> <span class="fw-bold text-light">{{ contract.instance.pk }}</span>
        </p>
      </div>

      <div class="text-end" style="min-width: 150px;">
        <span class="text-text-dim d-block mb-0">Fecha de Registro:</span>
        <span class="fw-bold text-status-ok">{{ contract.instance.created_at|date:'Y-m-d' }}</span>
      </div>
    </div>

    <div class="card status-card-table p-3">
      <ul class="nav nav-tabs" id="contractTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active text-accent" id="versions-tab" data-bs-toggle="tab" data-bs-target="#versions" type="button" role="tab" aria-controls="versions" aria-selected="true"><i class="bi bi-list-columns-reverse me-1"></i> Versiones ({{ contract.versions|length }})</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link text-accent" id="deployments-tab" data-bs-toggle="tab" data-bs-target="#deployments" type="button" role="tab" aria-controls="deployments" aria-selected="false"><i class="bi bi-broadcast-pin me-1"></i> Despliegues Activos ({{ contract.deployed_versions|length }})</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link text-accent" id="code-tab" data-bs-toggle="tab" data-bs-target="#code" type="button" role="tab" aria-controls="code" aria-selected="false" {% if not contract.versions %}disabled{% endif %}><i class="bi bi-code-slash me-1"></i> Bytecode & ABI</button>
        </li>
      </ul>

      <div class="tab-content pt-3" id="contractTabsContent">
        
        <div class="tab-pane fade show active" id="versions" role="tabpanel" aria-labelledby="versions-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-text-light mb-0">Historial de Versiones</h4>
            <a href="{% url 'contractRegistry:register_version' contract_id=contract.instance.pk %}" class="btn btn-outline-warning btn-sm fw-bold"><i class="bi bi-plus-circle-fill me-1"></i> Agregar Nueva Versión</a>
          </div>

          <p class="text-text-dim" style="text-align: justify;">Aquí se listan todas las versiones de este contrato base cargadas en la plataforma.</p>
          
          {% if contract.versions %}
          <table class="table table-dark table-striped table-hover">
            <thead>
              <tr>
                <th class="text-accent">Versión</th>
                <th scope="col" class="text-accent fw-bold">Contrato Base</th>
                <th class="text-accent">Fecha de Carga</th>
                <th class="text-accent">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for version in contract.versions %}
                <tr class="text-text-dim align-middle">
                  <td class="fw-bold text-light">{{ version.version }}</td>
                  <td class="fw-bold text-light">{{ version.base_contract.name }}</td>
                  <td>{{ version.created_at|date:"Y-m-d H:i" }}</td>
                  <td>
                    <a href="#" class="btn btn-sm btn-outline-success">
                      <i class="bi bi-arrow-up-right-square"></i> Usar/Desplegar
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="text-center p-4 border border-warning rounded">
              <i class="bi bi-exclamation-octagon-fill text-warning h4 d-block mb-2"></i>
              <p class="text-text-dim mb-0">Aún no hay versiones registradas para este contrato base.</p>
          </div>
          {% endif %}
        </div>

        <div class="tab-pane fade" id="deployments" role="tabpanel" aria-labelledby="deployments-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-text-light mb-0">Direcciones Desplegadas</h4>
            <a href="{% url 'contractRegistry:deploy_contract' %}" class="btn btn-outline-info btn-sm fw-bold"><i class="bi bi-broadcast-pin me-1"></i> Desplegar Versión</a>
          </div>

          <p class="text-text-dim" style="text-align: justify;">Instancias de este contrato actualmente activas en diferentes redes.</p>
          
          {% if contract.deployed_versions %}
          <table class="table table-dark table-striped">
            <thead>
              <tr>
                <th class="text-accent">Red</th>
                <th class="text-accent">Dirección (Address)</th>
                <th class="text-accent">Versión</th>
                <th class="text-accent">Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for deployment in contract.deployed_versions %}
                <tr class="text-text-dim">
                  <td class="fw-bold text-light">{{ deployment.network.name }}</td>
                  <td>{{ deployment.address|truncatechars:42 }}</td>
                  <td>{{ deployment.contract_version.version_number }}</td>
                  {% if deployment.is_current %}
                    <td class="text-success fw-bold">ACTIVO (Actual)</td>
                  {% else %}
                    <td class="text-warning fw-bold">Inactivo</td>
                  {% endif %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="text-center p-4 border border-info rounded">
              <i class="bi bi-info-circle-fill text-info h4 d-block mb-2"></i>
              <p class="text-text-dim mb-0">Este contrato aún no tiene despliegues registrados. Despliega una versión para verla aquí.</p>
          </div>
          {% endif %}
        </div>

        <div class="tab-pane fade" id="code" role="tabpanel" aria-labelledby="code-tab">
          {% with latest_version=contract.versions.0 %}
            {% if latest_version %}
              <h4 class="text-text-light mb-3">Bytecode & ABI (Versión {{ latest_version.version_number }})</h4>
              <p class="text-text-dim" style="text-align: justify;">Datos técnicos de la versión más reciente del contrato.</p>

              <label class="text-accent mb-1">Bytecode</label>
              <div class="bg-dark text-white border border-info p-2" style="font-family: monospace; white-space: pre-wrap; word-break: break-all; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                <!-- Asume que ContractVersion tiene un campo 'bytecode' -->
                <pre class="text-white m-0 p-0" style="text-align: justify;">{{ latest_version.bytecode|default:"No bytecode disponible para esta versión." }}</pre>
              </div>

              <label class="text-accent mt-3 mb-1">ABI (Application Binary Interface)</label>
              <div class="bg-dark text-white border border-info p-2" style="font-family: monospace; white-space: pre-wrap; word-break: break-all; border-radius: 5px; max-height: 250px; overflow-y: auto;">
                <!-- Asume que ContractVersion tiene un campo 'abi' -->
                <pre class="text-white m-0 p-0" style="text-align: justify;">{{ latest_version.abi|default:"No ABI disponible para esta versión." }}</pre>
              </div>
            {% else %}
              <div class="text-center p-4 border border-warning rounded">
                <i class="bi bi-code-slash text-warning h4 d-block mb-2"></i>
                <p class="text-text-dim mb-0">No hay versiones cargadas para mostrar el Bytecode o ABI.</p>
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
