{% extends "base.html" %}
{% load static %}

{% block title %}Confirmar Firma: {{ contract_name }} v{{ version_number }}{% endblock %}

{% block content %}

{{ contract_abi|json_script:"contract-abi-data" }}

{{ constructor_params_values|json_script:"constructor-params-data" }}

<div class="centered-container mx-auto dashboard-content py-4" style="max-width: 900px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4 border-0">
        <h2 class="h3 text-accent mb-0" style="border-bottom: none !important;">
            Firma y Despliegue en Blockchain
        </h2>
        <a href="{% url 'contractRegistry:deploy_contract' %}" 
           class="btn btn-outline-info fw-bold text-uppercase">
            <i class="bi bi-arrow-left-circle me-2"></i> Nuevo Despliegue
        </a>
    </div>
    
    <hr class="text-accent mt-0 mb-2"> 
    
    <div class="mb-4 welcome-card p-4">
        <p class="mb-1 lead text-text-dim">
            Revise los detalles antes de firmar. Su billetera (MetaMask) se abrir√° a continuaci√≥n para confirmar la transacci√≥n en la red.
        </p>
        <p class="mb-0 text-danger fw-bold" id="status-message">
            ‚ö†Ô∏è Estatus: Esperando conexi√≥n con Ethers.js y el proveedor...
        </p>
    </div>

    <div class="card status-card-table p-4 mb-4 border-info">
        <h4 class="text-text-light mb-4">Detalles de la Transacci√≥n</h4>
        
        <dl class="row detail-list mb-0">
            <dt class="col-sm-3 text-accent">Contrato:</dt>
            <dd class="col-sm-9 text-light">{{ contract_name }} (v{{ version_number }})</dd>

            <dt class="col-sm-3 text-accent">Red de Destino:</dt>
            <dd class="col-sm-9 text-info">{{ deployed_contract.network.name }} (Chain ID: {{ chain_id }})</dd>
            
            <dt class="col-sm-3 text-accent">Direcci√≥n Firmante:</dt>
            <dd class="col-sm-9 font-monospace text-warning">{{ deployer_address }}</dd>
        </dl>
        
        <hr class="text-text-dim my-3">
        
        <h5 class="text-text-light mt-3">Par√°metros del Constructor (JSON Final)</h5>
        <div class="bg-dark text-white border border-info p-3 rounded font-monospace" style="max-height: 250px; overflow-y: auto;">
            <pre id="final-params-display" class="m-0 p-0 text-white small">Cargando par√°metros...</pre>
        </div>
        
    </div>

    <div class="d-grid mt-4">
        <button type="button" id="start-deployment-btn" class="btn btn-success fw-bold text-uppercase" disabled>
            <i class="bi bi-wallet-fill me-2"></i> Iniciar Firma con Billetera
        </button>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}

<script>
    // =======================================================================
    // 1. VARIABLES DE CONTEXTO (PASADAS DESDE DJANGO)
    // =======================================================================
    const DEPLOYMENT_ID = "{{ deployed_contract.pk }}";
    const CONTRACT_BYTECODE = "{{ contract_bytecode }}"; 
    const DEPLOYER_ADDRESS = "{{ deployer_address }}";
    
    // üí• CORRECCI√ìN ABI: Leer el ABI del script tag y parsearlo üí•
    const abiElement = document.getElementById('contract-abi-data');
    let CONTRACT_ABI = [];
    if (abiElement && abiElement.textContent) {
        try {
            CONTRACT_ABI = JSON.parse(abiElement.textContent);
        } catch (e) {
            console.error("Error al parsear CONTRACT_ABI. Verifique el formato JSON:", e);
        }
    }

    // Lectura de Par√°metros (Usando el mismo patr√≥n de correcci√≥n)
    const paramsElement = document.getElementById('constructor-params-data');
    let CONSTRUCTOR_PARAMS_VALUES = {};
    if (paramsElement && paramsElement.textContent) {
        try {
            CONSTRUCTOR_PARAMS_VALUES = JSON.parse(paramsElement.textContent);
        } catch (e) {
            console.error("Error al parsear CONSTRUCTOR_PARAMS_VALUES. Verifique el formato JSON:", e);
        }
    }
    // =======================================================================
    
    document.addEventListener('DOMContentLoaded', async function() {
        const statusMessage = document.getElementById('status-message');
        const startDeploymentBtn = document.getElementById('start-deployment-btn');
        const finalParamsDisplay = document.getElementById('final-params-display');

        const { ethers } = window;
        let provider;
        let signer;

        // 1. Mostrar los par√°metros reales en la UI
        finalParamsDisplay.textContent = JSON.stringify(CONSTRUCTOR_PARAMS_VALUES, null, 2);

        // 2. Conexi√≥n y chequeo de MetaMask (Proveedor)
        if (typeof window.ethereum === 'undefined') {
            statusMessage.innerHTML = "‚ùå <strong>ERROR:</strong> MetaMask/Proveedor EVM no est√° instalado.";
            return;
        }

        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();

            startDeploymentBtn.disabled = false;
            statusMessage.innerHTML = "‚úÖ Estatus: Listo para iniciar el despliegue.";
        } catch (error) {
            console.error("Error al conectar con el proveedor:", error);
            statusMessage.innerHTML = "‚ùå <strong>ERROR:</strong> No se pudo conectar a su billetera. Revise MetaMask y acepte la conexi√≥n.";
            return;
        }

        startDeploymentBtn.addEventListener('click', async () => {
            statusMessage.innerHTML = "‚è≥ Esperando confirmaci√≥n en MetaMask...";
            startDeploymentBtn.disabled = true;

            try {
                const currentAccount = await signer.getAddress();

                // Validaci√≥n de la Direcci√≥n
                if (currentAccount.toLowerCase() !== DEPLOYER_ADDRESS.toLowerCase()) {
                    statusMessage.innerHTML = `‚ö†Ô∏è <strong>ERROR:</strong> Por favor, cambia tu billetera a la direcci√≥n autorizada: <span class="font-monospace">${DEPLOYER_ADDRESS}</span>`;
                    startDeploymentBtn.disabled = false;
                    return; 
                }
                
                // Preparar los argumentos como un array de valores ordenados
                const argsArray = Object.values(CONSTRUCTOR_PARAMS_VALUES);
                
                // 3. Crear la F√°brica de Contratos (ContractFactory)
                const factory = new ethers.ContractFactory(CONTRACT_ABI, CONTRACT_BYTECODE, signer);

                // 4. Iniciar el despliegue
                const contract = await factory.deploy(...argsArray); 
                
                statusMessage.innerHTML = `üöÄ Transacci√≥n enviada. Hash: <span class="font-monospace text-info">${contract.deploymentTransaction().hash}</span>. Esperando confirmaci√≥n...`;

                // 5. Esperar la confirmaci√≥n (mining)
                const receipt = await contract.deploymentTransaction().wait(); 

                // 6. Despliegue Exitoso
                statusMessage.innerHTML = `üéâ Despliegue Exitoso! Direcci√≥n del Contrato: <span class="font-monospace text-success">${receipt.contractAddress}</span>`;
                
                // **TO-DO:** Llamar a una API de Django para actualizar el estado final (address, gas_used, etc.)
                
                startDeploymentBtn.remove();
                
            } catch (error) {
                console.error("Error de Despliegue:", error);
                
                let errorMessage = 'Fallo desconocido en la transacci√≥n.';
                if (error.code === 'ACTION_REJECTED' || (error.message && error.message.includes('user rejected transaction'))) {
                    errorMessage = 'Firma rechazada por el usuario.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                statusMessage.innerHTML = `‚ùå <strong>ERROR DE TRANSACCI√ìN:</strong> ${errorMessage}`;
                startDeploymentBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}