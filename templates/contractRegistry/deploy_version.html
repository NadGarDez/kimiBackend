{% extends "base.html" %}
{% load static %}

{% block title %}Registry - Desplegar Versión de Contrato{% endblock %}

{% block content %}

<div class="centered-container mx-auto dashboard-content py-4" style="max-width: 900px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4 border-0">
        <h2 class="h3 text-accent mb-0" style="border-bottom: none !important;">
            Desplegar Contrato a la Red
        </h2>
        <a href="{% url 'contractRegistry:index' %}" 
           class="btn btn-outline-info fw-bold text-uppercase">
            <i class="bi bi-arrow-left-circle me-2"></i> Volver a la Lista
        </a>
    </div>
    
    <hr class="text-accent mt-0 mb-2"> 
    
    <div class="mb-2 welcome-card p-4">
        <p class="mb-0 text-text-dim">
            Selecciona el contrato, la versión y la red de destino. Una vez seleccionado, se generará el template JSON para los argumentos.
        </p>
    </div>

    <form method="POST" action="{% url 'contractRegistry:deploy_contract' %}">
        {% csrf_token %}
        
        <div class="card status-card-table p-4 mb-4">
            
            <h4 class="text-text-light mb-4">Selección de Artefactos y Red</h4>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ deploy_form.base_contract.id_for_label }}" class="form-label text-accent">
                        Contrato Base
                    </label>
                    {{ deploy_form.base_contract }} 
                    <div class="form-text text-text-dim">Contrato lógico a desplegar.</div>
                    {% if deploy_form.base_contract.errors %}
                        <div class="text-warning mt-1">{{ deploy_form.base_contract.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-md-6 mb-3">
                    <label for="{{ deploy_form.version.id_for_label }}" class="form-label text-accent">
                        Versión Registrada
                    </label>
                    {{ deploy_form.version }}
                    <div class="form-text text-text-dim">Bytecode y ABI asociados.</div>
                    {% if deploy_form.version.errors %}
                        <div class="text-warning mt-1">{{ deploy_form.version.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row">
                
                <div class="col-md-6 mb-4">
                    <label for="{{ deploy_form.network.id_for_label }}" class="form-label text-accent">
                        Red de Destino
                    </label>
                    <div class="input-group">
                        {{ deploy_form.network }}
                        
                        <a href="{% url 'contractRegistry:register_network' %}"
                           class="btn btn-warning fw-bold text-uppercase" >
                            <i class="bi bi-plus-lg me-1"></i> Añadir Red
                        </a>
                    </div>
                    <div class="form-text text-text-dim">Red blockchain donde se ejecutará el despliegue.</div>
                    
                    {% if deploy_form.network.errors %}
                        <div class="text-warning mt-1">{{ deploy_form.network.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="col-md-6 mb-4">
                    <label for="{{ deploy_form.deployer.id_for_label }}" class="form-label text-accent">
                        Dirección Desplegadora
                    </label>
                    {{ deploy_form.deployer }}
                    <div class="form-text text-text-dim">Monedero autorizado que firmará el despliegue (campo 'from').</div>
                    
                    {% if deploy_form.deployer.errors %}
                        <div class="text-warning mt-1">{{ deploy_form.deployer.errors }}</div>
                    {% endif %}
                </div>

            </div>
            
            <div class="mb-4">
                <label for="id_params" class="form-label text-accent">
                    Parametros del Constructor (JSON)
                    <span id="arg-count" class="badge bg-info ms-2">0</span> Requeridos
                </label>
                <textarea id="id_params" name="params" 
                          class="form-control bg-dark text-light border border-info font-monospace" 
                          rows="8" 
                          placeholder="JSON generado automáticamente..."></textarea>
                <div id="args-message" class="form-text text-text-dim">
                    Selecciona la versión para generar la estructura JSON con valores por defecto.
                </div>
            </div>
            
            {% if deploy_form.non_field_errors %}
                <div class="alert alert-warning mt-3" role="alert">
                    <p class="fw-bold mb-0">⚠️ Errores Generales del Despliegue:</p>
                    <ul>
                        {% for error in deploy_form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

        </div>
        
        <div id="constructor-args-container" class="card status-card-table p-4 border-info">
            <h4 class="text-text-light mb-4">Ejecutar Despliegue</h4>
            
            <div class="d-grid mt-4">
                <button type="submit" id="deploy-button" class="btn btn-info fw-bold text-uppercase" disabled>
                    <i class="bi bi-rocket-takeoff me-2"></i> Iniciar Despliegue
                </button>
            </div>
        </div>
        
    </form>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const versionSelect = document.getElementById('{{ deploy_form.version.id_for_label }}');
        const paramsTextarea = document.getElementById('id_params');
        const argCountSpan = document.getElementById('arg-count');
        const argsMessage = document.getElementById('args-message');
        const deployButton = document.getElementById('deploy-button');
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        function getDefaultValueForType(type) {
            const normalizedType = type.startsWith('u') ? type.substring(1) : type; 
            if (normalizedType.startsWith('int') || normalizedType === 'address') {
                return null; 
            }
            if (normalizedType === 'bool') {
                return false;
            }
            if (normalizedType.endsWith('[]')) { 
                return [];
            }
            if (normalizedType.startsWith('bytes') || normalizedType === 'string') {
                return ""; 
            }
            if (normalizedType === 'tuple') {
                return {}; 
            }
            return null;
        }

        async function fetchConstructorArgs(versionId) {
            paramsTextarea.value = ''; 
            argsMessage.textContent = 'Cargando argumentos...';
            argCountSpan.textContent = '...';
            deployButton.disabled = true;

            try {
                const url = `/contractRegistry/version/version_args/${versionId}/`; 
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Error al cargar la versión.');
                }

                const data = await response.json();
                const args = data.args || []; 
                const defaultParams = {}; 

                if (args.length > 0) {
                    argsMessage.textContent = 'El template JSON ha sido generado con valores por defecto (null, [], ""). Edítalo cuidadosamente.';
                    argCountSpan.textContent = args.length;
                    
                    args.forEach(arg => {
                        defaultParams[arg.name] = getDefaultValueForType(arg.type);
                    });
                    
                } else {
                    argsMessage.textContent = '¡Esta versión de contrato no requiere argumentos! El JSON de parámetros es vacío ({})';
                    argCountSpan.textContent = '0';
                }

                paramsTextarea.value = JSON.stringify(defaultParams, null, 2);

                deployButton.disabled = false;

            } catch (error) {
                console.error('Error fetching constructor arguments:', error);
                argsMessage.textContent = 'Error al cargar los argumentos. Asegúrate de que la API esté funcionando correctamente.';
                argCountSpan.textContent = 'Error';
                paramsTextarea.value = '{"error": "No se pudo cargar la estructura de parámetros."}';
                deployButton.disabled = true;
            }
        }

        versionSelect.addEventListener('change', function() {
            const selectedVersionId = this.value;

            if (selectedVersionId) {
                fetchConstructorArgs(selectedVersionId);
            } else {
                paramsTextarea.value = '';
                argsMessage.textContent = 'Selecciona la versión para generar la estructura JSON con valores por defecto.';
                argCountSpan.textContent = '0';
                deployButton.disabled = true;
            }
        });
        
        if (versionSelect.value) {
            fetchConstructorArgs(versionSelect.value);
        }
    });
</script>
{% endblock %}